# 用户评分类别功能说明

## 功能概述

新增了用户（述职人员）评分类别关联功能。管理员可以为述职人员设置评分类别，评委在选择类别打分时，只会显示该类别下的述职人员。

## 主要特性

### 1. 述职人员类别管理
- 管理员可以在创建或编辑述职人员时，选择其所属的评分类别
- 只有"述职人员"角色才可以设置评分类别
- 评委和管理员不需要设置评分类别

### 2. 评委打分筛选
- 评委选择某个评分类别后，只会看到该类别下的述职人员
- 评委可以给不同类别的述职人员分别打分
- 如果述职人员没有设置类别，在选择类别打分时不会显示

## 数据库变更

### 需要执行的SQL脚本

运行以下脚本来更新数据库结构：

```bash
mysql -u用户名 -p 数据库名 < scripts/add_user_category.sql
```

### 脚本内容

- 为 `users` 表添加 `category_id` 字段
- 添加外键约束，关联到 `score_categories` 表
- 删除类别时，关联用户的 `category_id` 会被设为 NULL

## 使用流程

### 管理员配置

1. **配置评分类别**
   - 进入"评分类别"标签页
   - 创建需要的评分类别（如：技术类、管理类等）

2. **配置述职人员**
   - 进入"用户管理"标签页
   - 添加或编辑述职人员
   - 在"角色"选择为"述职人员"时，会出现"评分类别"下拉框
   - 选择该述职人员所属的类别

### 评委使用

1. **选择评分类别**
   - 评委登录后，进入类别选择页面
   - 选择要评分的类别（如：技术类）

2. **查看述职人员**
   - 进入打分页面后，只会显示该类别下的述职人员
   - 例如：选择"技术类"，只会显示属于"技术类"的述职人员

3. **切换类别打分**
   - 完成一个类别的打分后，可以返回类别选择页面
   - 选择其他类别继续打分

## 数据结构变更

### User 类型更新

```typescript
export interface User {
  id: string
  name: string
  role: UserRole
  categoryId?: string      // 新增：评分类别ID（仅述职人员使用）
  categoryName?: string    // 新增：评分类别名称（仅述职人员使用）
  password?: string
}
```

## API 变更

### 更新的 API

- `GET /api/users?role=presenter&categoryId=xxx` - 获取指定类别的述职人员
- `POST /api/users` - 创建用户时可以包含 `categoryId`
- `PUT /api/users` - 更新用户时可以修改 `categoryId`

## 界面变更

### 管理员界面（/admin）

1. **用户管理列表**
   - 新增"评分类别"列，显示述职人员所属类别

2. **用户编辑/新增模态框**
   - 当角色选择为"述职人员"时，显示"评分类别"下拉框
   - 可以选择已有的评分类别或"无类别"

### 评委界面（/judge）

- 根据选择的类别参数，自动筛选显示对应类别的述职人员
- 如果没有选择类别，显示所有述职人员

## 注意事项

1. **向后兼容**
   - 未设置类别的述职人员（`categoryId` 为 NULL）在选择类别打分时不会显示
   - 不影响原有的直接打分功能

2. **类别删除**
   - 删除评分类别不会删除述职人员
   - 删除类别后，关联用户的类别会被清除

3. **角色限制**
   - 只有述职人员可以设置评分类别
   - 评委和管理员不需要也不能设置类别

4. **打分逻辑**
   - 评委可以对不同类别的述职人员分别打分
   - 评分统计时会按类别分组显示

## 示例场景

### 场景1：技术部门和管理部门分类评分

1. 管理员创建两个类别：
   - "技术能力评分"
   - "管理能力评分"

2. 管理员配置述职人员：
   - 张三（述职人员）→ 技术能力评分
   - 李四（述职人员）→ 管理能力评分

3. 评委打分：
   - 评委A 选择"技术能力评分" → 只看到张三
   - 评委A 选择"管理能力评分" → 只看到李四

### 场景2：多个述职人员同一类别

1. 管理员配置：
   - 王五（述职人员）→ 技术能力评分
   - 赵六（述职人员）→ 技术能力评分

2. 评委打分：
   - 评委B 选择"技术能力评分" → 看到张三、王五、赵六
   - 可以依次给这些述职人员打分

## 技术实现细节

### 数据库层面
- `users.category_id` 外键关联 `score_categories.id`
- 级联删除策略：`ON DELETE SET NULL`

### 后端层面
- 新增 `getUsersByRoleAndCategory` 方法
- 更新 `addUser` 和 `updateUser` 支持 `categoryId`

### 前端层面
- 管理员界面动态显示类别选择（仅述职人员）
- 评委界面根据 URL 参数 `categoryId` 筛选述职人员
